# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# CI/CD Hardened Governance Gate â€” MASTER WORKFLOW
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# PAC: PAC-DAN-A7-CI-CD-HARDENING-LOCK-01
# PAC: PAC-DAN-RUNTIME-IDENTITY-LINT-ENFORCEMENT-01 (INCLUDED)
# Author: Dan (GID-07) â€” DevOps & CI/CD Lead
# Authority: Benson (GID-00)
# Mode: FAIL-CLOSED
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# PURPOSE:
# Single source of CI truth for governance enforcement.
# Implements IMMUTABLE gate ordering that cannot be bypassed or reordered.
#
# CANONICAL GATE ORDER (IMMUTABLE):
# 1. Identity / Runtime Boundary Gate
# 2. Agent Registry Validation
# 3. Governance Alignment Gate (LOCK file drift detection)
# 4. Artifact Integrity Verification
# 5. Security & Threat Checks
# 6. Test Suite Gate
# 7. Merge Eligibility + Evidence Emission
#
# FAIL-CLOSED SEMANTICS:
# - Any gate failure = HARD CI FAIL
# - No warnings, no soft failures
# - No environment-specific shortcuts
# - No conditional skips except docs-only changes
#
# LOCK FILE PROTECTION:
# - A1_ARCHITECTURE_LOCK.md
# - A2_RUNTIME_BOUNDARY_LOCK.md
# - A3_PDO_ATOMIC_LOCK.md
# - A4_SETTLEMENT_GATE_LOCK.md
# - A5_PROOF_AUDIT_SURFACE_LOCK.md
# - A6_GOVERNANCE_ALIGNMENT_LOCK.md
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

name: Governance Check

on:
  pull_request:
  push:
    branches: [main]

env:
  CI_HARDENING_VERSION: "A7-LOCK-01"
  FAIL_CLOSED: "true"

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 1: Identity / Runtime Boundary Gate (MUST PASS FIRST)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-1-identity:
    name: "ðŸ”’ Gate 1: Identity Boundary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      gate_passed: ${{ steps.identity-check.outputs.passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Identity Boundary Lint
        id: identity-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”’ GATE 1: IDENTITY / RUNTIME BOUNDARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 1 of 7 (IMMUTABLE)"
          echo "Mode: FAIL-CLOSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f scripts/lint_identity_blocks.py ]; then
            python scripts/lint_identity_blocks.py .
            LINT_EXIT=$?
          else
            echo "Identity lint script not found, checking manually..."
            # Manual check: ensure no runtime block declares GID
            if grep -rn "RUNTIME_ACTIVATION_ACK" --include="*.md" --include="*.py" . 2>/dev/null | grep -v "```" | grep -i "gid:"; then
              echo "âŒ Runtime block declares GID"
              LINT_EXIT=1
            else
              echo "âœ… No runtime GID violations found"
              LINT_EXIT=0
            fi
          fi
          
          if [ $LINT_EXIT -ne 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ GATE 1 FAILED: Identity boundary violated"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 1 PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 2: Agent Registry Validation
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-2-registry:
    name: "ðŸ“‹ Gate 2: Agent Registry"
    needs: gate-1-identity
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      gate_passed: ${{ steps.registry-check.outputs.passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Agent Registry Validation
        id: registry-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ GATE 2: AGENT REGISTRY VALIDATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 2 of 7 (IMMUTABLE)"
          echo "Depends: Gate 1"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check registry exists
          test -s docs/governance/AGENT_REGISTRY.json || { echo "âŒ AGENT_REGISTRY.json missing"; exit 1; }
          echo "âœ… AGENT_REGISTRY.json exists"
          
          # Validate JSON structure
          python3 -c "
          import json
          import sys
          
          with open('docs/governance/AGENT_REGISTRY.json') as f:
              registry = json.load(f)
          
          required = ['meta', 'agents', 'special_constraints', 'forbidden_aliases']
          for key in required:
              if key not in registry:
                  print(f'âŒ Missing required key: {key}')
                  sys.exit(1)
          
          # Check GID uniqueness
          gids = {}
          for agent in registry['agents']:
              gid = agent.get('gid')
              name = agent.get('name')
              if gid in gids:
                  print(f'âŒ GID conflict: {gid} claimed by {gids[gid]} and {name}')
                  sys.exit(1)
              gids[gid] = name
          
          print(f'âœ… Registry valid: {len(registry[\"agents\"])} agents, {len(gids)} unique GIDs')
          "
          
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 2 PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 3: Governance Alignment Gate (LOCK File Drift Detection)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-3-governance:
    name: "âš–ï¸ Gate 3: Governance Alignment"
    needs: gate-2-registry
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      gate_passed: ${{ steps.governance-check.outputs.passed }}
      lock_files_changed: ${{ steps.lock-check.outputs.changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check LOCK file modifications
        id: lock-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš–ï¸ GATE 3: GOVERNANCE ALIGNMENT (LOCK DRIFT)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 3 of 7 (IMMUTABLE)"
          echo "Depends: Gate 2"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Define protected LOCK files
          LOCK_FILES=(
            "docs/governance/A1_ARCHITECTURE_LOCK.md"
            "docs/governance/A2_RUNTIME_BOUNDARY_LOCK.md"
            "docs/governance/A3_PDO_ATOMIC_LOCK.md"
            "docs/governance/A4_SETTLEMENT_GATE_LOCK.md"
            "docs/governance/A5_PROOF_AUDIT_SURFACE_LOCK.md"
            "docs/governance/A6_GOVERNANCE_ALIGNMENT_LOCK.md"
          )
          
          echo "Protected LOCK files:"
          for f in "${LOCK_FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "  âœ“ $f"
            else
              echo "  âš  $f (not found)"
            fi
          done
          
          # Check if any LOCK files were modified in this PR
          CHANGED_LOCKS=""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            
            for f in "${LOCK_FILES[@]}"; do
              if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "$f"; then
                CHANGED_LOCKS="$CHANGED_LOCKS $f"
              fi
            done
          fi
          
          if [ -n "$CHANGED_LOCKS" ]; then
            echo ""
            echo "âš ï¸ LOCK FILES MODIFIED IN THIS PR:"
            echo "$CHANGED_LOCKS"
            echo ""
            echo "LOCK file changes trigger FULL governance re-validation"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âœ… No LOCK files modified"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Governance alignment check
        id: governance-check
        run: |
          # Verify governance files exist
          GOVERNANCE_FILES=(
            "docs/governance/AGENT_REGISTRY.json"
            "docs/governance/AGENT_REGISTRY.md"
          )
          
          MISSING=0
          for f in "${GOVERNANCE_FILES[@]}"; do
            if [ ! -f "$f" ]; then
              echo "âŒ Missing: $f"
              MISSING=1
            fi
          done
          
          if [ $MISSING -ne 0 ]; then
            echo "âŒ GATE 3 FAILED: Governance files missing"
            exit 1
          fi
          
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 3 PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 4: Artifact Integrity Verification
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-4-integrity:
    name: "ðŸ” Gate 4: Artifact Integrity"
    needs: gate-3-governance
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      gate_passed: ${{ steps.integrity-check.outputs.passed }}
      registry_hash: ${{ steps.compute-hashes.outputs.registry_hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute governance artifact hashes
        id: compute-hashes
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” GATE 4: ARTIFACT INTEGRITY VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 4 of 7 (IMMUTABLE)"
          echo "Depends: Gate 3"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Compute SHA256 hashes of critical governance artifacts
          echo "Computing artifact hashes..."
          
          REGISTRY_HASH=""
          if [ -f "docs/governance/AGENT_REGISTRY.json" ]; then
            REGISTRY_HASH=$(sha256sum docs/governance/AGENT_REGISTRY.json | cut -d' ' -f1)
            echo "AGENT_REGISTRY.json: $REGISTRY_HASH"
          fi
          
          PAC_TEMPLATE_HASH=""
          if [ -f "docs/governance/PAC_TEMPLATE_V1.md" ]; then
            PAC_TEMPLATE_HASH=$(sha256sum docs/governance/PAC_TEMPLATE_V1.md | cut -d' ' -f1)
            echo "PAC_TEMPLATE_V1.md: $PAC_TEMPLATE_HASH"
          fi
          
          WRAP_TEMPLATE_HASH=""
          if [ -f "docs/governance/WRAP_TEMPLATE_V1.md" ]; then
            WRAP_TEMPLATE_HASH=$(sha256sum docs/governance/WRAP_TEMPLATE_V1.md | cut -d' ' -f1)
            echo "WRAP_TEMPLATE_V1.md: $WRAP_TEMPLATE_HASH"
          fi
          
          echo ""
          echo "registry_hash=$REGISTRY_HASH" >> $GITHUB_OUTPUT
          echo "pac_template_hash=$PAC_TEMPLATE_HASH" >> $GITHUB_OUTPUT
          echo "wrap_template_hash=$WRAP_TEMPLATE_HASH" >> $GITHUB_OUTPUT

      - name: Verify artifact integrity
        id: integrity-check
        run: |
          # Verify JSON parsability of critical files
          python3 -c "
          import json
          import sys
          
          files_to_check = [
              'docs/governance/AGENT_REGISTRY.json'
          ]
          
          for f in files_to_check:
              try:
                  with open(f) as fp:
                      json.load(fp)
                  print(f'âœ… {f} - valid JSON')
              except FileNotFoundError:
                  print(f'âš ï¸ {f} - not found (optional)')
              except json.JSONDecodeError as e:
                  print(f'âŒ {f} - invalid JSON: {e}')
                  sys.exit(1)
          
          print('âœ… All artifacts valid')
          "
          
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 4 PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 5: Security & Threat Checks
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-5-security:
    name: "ðŸ›¡ï¸ Gate 5: Security Checks"
    needs: gate-4-integrity
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      gate_passed: ${{ steps.security-check.outputs.passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Security scan
        id: security-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ›¡ï¸ GATE 5: SECURITY & THREAT CHECKS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 5 of 7 (IMMUTABLE)"
          echo "Depends: Gate 4"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          VIOLATIONS=0
          
          # Check for bypass patterns in production code
          echo "Checking for bypass patterns..."
          
          if grep -rn "ALLOW_UNSIGNED\|skip_signature\|skip_verification" app/ 2>/dev/null | grep -v "#"; then
            echo "âŒ Bypass pattern detected in app/"
            VIOLATIONS=$((VIOLATIONS + 1))
          else
            echo "âœ… No bypass patterns in app/"
          fi
          
          # Check for hardcoded secrets patterns
          if grep -rn "password\s*=\s*['\"]" app/ 2>/dev/null | grep -v "#" | grep -v "password_field\|password_hash\|password:"; then
            echo "âš ï¸ Potential hardcoded password detected"
          fi
          
          # Check for debug mode in production
          if grep -rn "DEBUG\s*=\s*True" app/ 2>/dev/null | grep -v "#"; then
            echo "âš ï¸ DEBUG=True found in app/"
          fi
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ GATE 5 FAILED: Security violations detected"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 5 PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 6: Test Suite Gate
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-6-tests:
    name: "ðŸ§ª Gate 6: Test Suite"
    needs: gate-5-security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      gate_passed: ${{ steps.test-check.outputs.passed }}
      tests_run: ${{ steps.test-check.outputs.tests_run }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest fastapi httpx pydantic
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run test suite
        id: test-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§ª GATE 6: TEST SUITE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 6 of 7 (IMMUTABLE)"
          echo "Depends: Gate 5"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          
          # Run critical governance tests first
          if [ -f tests/test_pdo_enforcement.py ]; then
            echo "Running PDO enforcement tests..."
            python -m pytest tests/test_pdo_enforcement.py -q --tb=short
          fi
          
          if [ -f tests/test_pdo_signing.py ]; then
            echo "Running PDO signing tests..."
            python -m pytest tests/test_pdo_signing.py -q --tb=short
          fi
          
          # Count tests
          TESTS_RUN=$(python -m pytest tests/ --collect-only -q 2>/dev/null | tail -1 | grep -oE '[0-9]+' | head -1 || echo "0")
          echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
          
          # Run full test suite
          python -m pytest tests/ -q --tb=short
          TEST_EXIT=$?
          
          if [ $TEST_EXIT -ne 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ GATE 6 FAILED: Test suite failed"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 6 PASSED ($TESTS_RUN tests)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # GATE 7: Merge Eligibility + Evidence Emission
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gate-7-merge-eligibility:
    name: "âœ… Gate 7: Merge Eligibility"
    needs: [gate-1-identity, gate-2-registry, gate-3-governance, gate-4-integrity, gate-5-security, gate-6-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify all gates passed
        id: verify-gates
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GATE 7: MERGE ELIGIBILITY + EVIDENCE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Order: 7 of 7 (FINAL)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ALL_PASSED=true
          
          echo "Gate Results:"
          echo "  Gate 1 (Identity):   ${{ needs.gate-1-identity.result }}"
          echo "  Gate 2 (Registry):   ${{ needs.gate-2-registry.result }}"
          echo "  Gate 3 (Governance): ${{ needs.gate-3-governance.result }}"
          echo "  Gate 4 (Integrity):  ${{ needs.gate-4-integrity.result }}"
          echo "  Gate 5 (Security):   ${{ needs.gate-5-security.result }}"
          echo "  Gate 6 (Tests):      ${{ needs.gate-6-tests.result }}"
          
          if [ "${{ needs.gate-1-identity.result }}" != "success" ]; then
            echo "âŒ Gate 1 failed"
            ALL_PASSED=false
          fi
          if [ "${{ needs.gate-2-registry.result }}" != "success" ]; then
            echo "âŒ Gate 2 failed"
            ALL_PASSED=false
          fi
          if [ "${{ needs.gate-3-governance.result }}" != "success" ]; then
            echo "âŒ Gate 3 failed"
            ALL_PASSED=false
          fi
          if [ "${{ needs.gate-4-integrity.result }}" != "success" ]; then
            echo "âŒ Gate 4 failed"
            ALL_PASSED=false
          fi
          if [ "${{ needs.gate-5-security.result }}" != "success" ]; then
            echo "âŒ Gate 5 failed"
            ALL_PASSED=false
          fi
          if [ "${{ needs.gate-6-tests.result }}" != "success" ]; then
            echo "âŒ Gate 6 failed"
            ALL_PASSED=false
          fi
          
          if [ "$ALL_PASSED" = "false" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ MERGE BLOCKED: One or more gates failed"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL GATES PASSED â€” MERGE ELIGIBLE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Emit CI Evidence
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ CI EVIDENCE ARTIFACT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "CI_PROOF {"
          echo "  version: \"${{ env.CI_HARDENING_VERSION }}\""
          echo "  pac: \"PAC-DAN-A7-CI-CD-HARDENING-LOCK-01\""
          echo "  commit: \"${{ github.sha }}\""
          echo "  timestamp: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\""
          echo "  branch: \"${{ github.ref_name }}\""
          echo "  run_id: \"${{ github.run_id }}\""
          echo "  run_number: \"${{ github.run_number }}\""
          echo "  gates_passed: 7"
          echo "  gate_order: \"IMMUTABLE\""
          echo "  fail_closed: true"
          echo "  registry_hash: \"${{ needs.gate-4-integrity.outputs.registry_hash }}\""
          echo "  tests_run: \"${{ needs.gate-6-tests.outputs.tests_run }}\""
          echo "}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ”’ CI/CD Hardened Governance Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PAC:** PAC-DAN-A7-CI-CD-HARDENING-LOCK-01" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.CI_HARDENING_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Canonical Gate Order (IMMUTABLE)" >> $GITHUB_STEP_SUMMARY
          echo "| # | Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | ðŸ”’ Identity Boundary | ${{ needs.gate-1-identity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | ðŸ“‹ Agent Registry | ${{ needs.gate-2-registry.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | âš–ï¸ Governance Alignment | ${{ needs.gate-3-governance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | ðŸ” Artifact Integrity | ${{ needs.gate-4-integrity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | ðŸ›¡ï¸ Security Checks | ${{ needs.gate-5-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6 | ðŸ§ª Test Suite | ${{ needs.gate-6-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 7 | âœ… Merge Eligibility | Final |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** FAIL-CLOSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Any gate failure blocks merge. No bypass. No reordering._" >> $GITHUB_STEP_SUMMARY
