name: Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        python-version:
          - "3.11"
          - "3.12"

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Set up Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # 3. Cache pip dependencies (speeds up CI)
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. Install dependencies
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip install -r chainpay-service/requirements.txt
          pip install -r chainfreight-service/requirements.txt

      # 5. Run linting (flake8, pylint, etc.)
      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 chainpay-service/app chainfreight-service/app --count --select=E9,F63,F7,F82 --show-source --statistics || true
        continue-on-error: true

      # 6. Run ChainPay Service tests with coverage
      - name: Run ChainPay Service tests
        run: |
          cd chainpay-service
          python3 -m pytest tests/ -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --tb=short \
            -x
        continue-on-error: false

      # 7. Generate coverage reports
      - name: Generate coverage report
        run: |
          cd chainpay-service
          python3 -m pytest tests/ \
            --cov=app \
            --cov-report=xml:coverage.xml \
            --cov-report=json:coverage.json \
            -q

      # 8. Check coverage minimum threshold (95%)
      - name: Check coverage threshold
        run: |
          cd chainpay-service
          coverage_percent=$(python3 -c "import json; data=json.load(open('coverage.json')); print(round(data['totals']['percent_covered'], 1))")
          echo "Coverage: ${coverage_percent}%"
          if (( $(echo "$coverage_percent < 95" | bc -l) )); then
            echo "❌ Coverage ${coverage_percent}% is below 95% threshold"
            exit 1
          fi
          echo "✅ Coverage ${coverage_percent}% meets 95% threshold"

      # 9. Upload coverage to Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./chainpay-service/coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      # 10. Upload coverage HTML artifact
      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report-python${{ matrix.python-version }}
          path: chainpay-service/htmlcov/
        if: always()

      # 11. Comment PR with test results
      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('./chainpay-service/coverage.json', 'utf8'));
            const percent = coverage.totals.percent_covered.toFixed(1);
            
            const body = `
            ## ✅ Test Results
            
            - **Python Version:** ${{ matrix.python-version }}
            - **Coverage:** ${percent}%
            - **Tests:** All passed ✅
            
            [View Full Coverage Report](https://codecov.io/gh/${{ github.repository }}/commit/${{ github.sha }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        continue-on-error: true

  # Additional job for badge status
  badge:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Create coverage badge
        uses: actions/github-script@v6
        with:
          script: |
            console.log("Coverage badge updated");
