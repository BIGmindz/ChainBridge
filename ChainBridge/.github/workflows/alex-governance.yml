name: ALEX Governance

on:
  pull_request:
    branches: [ main, feature/* ]
  push:
    branches: [ main ]

jobs:
  governance-checks:
    name: ALEX Governance Layer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Need history for commit message checks

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install governance dependencies
        run: |
          python -m pip install --upgrade pip
          # Governance tool has no external dependencies

      - name: Run ALEX Governance Checks
        id: governance
        run: |
          echo "üü© Running ALEX Governance Layer..."
          python tools/governance_python.py
        continue-on-error: true

      - name: Check governance result
        if: steps.governance.outcome == 'failure'
        run: |
          echo "::error::‚ùå ALEX Governance checks failed. See logs above for details."
          exit 1

      - name: Governance passed
        if: steps.governance.outcome == 'success'
        run: |
          echo "‚úÖ ALEX Governance: All checks passed"

  security-scan:
    name: Security Baseline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

      - name: Check for crypto vulnerabilities
        run: |
          echo "üîç Scanning for RSA/ECDSA usage..."
          if grep -r "import rsa" --include="*.py" . || \
             grep -r "from cryptography.hazmat.primitives.asymmetric import rsa" --include="*.py" . || \
             grep -r "import ecdsa" --include="*.py" .; then
            echo "::error::‚ùå Found non-quantum-safe cryptography. Use Dilithium/Kyber only."
            exit 1
          fi
          echo "‚úÖ No forbidden crypto imports found"

  lint-and-format:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy

      - name: Run Ruff
        run: |
          ruff check chainiq-service/ chainpay-service/ tools/ --exclude __pycache__
        continue-on-error: true

      - name: Run Black check
        run: |
          black --check chainiq-service/ chainpay-service/ tools/ --exclude __pycache__
        continue-on-error: true

      - name: Run MyPy (type checking)
        run: |
          mypy chainiq-service/app --ignore-missing-imports
        continue-on-error: true
