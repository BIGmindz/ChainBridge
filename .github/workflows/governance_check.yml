name: ALEX Governance Check
# Governance ID: GID-08-CI | Classification: CRITICAL | Owner: ALEX (GID-08) + Dan (GID-04)

on:
  pull_request:
    branches: [main, develop, feature/*, release/*]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  ALEX_MODE: protection
  FAIL_ON_VIOLATION: true
  PYTHON_VERSION: '3.11'

jobs:
  governance-pre-check:
    name: "ALEX Pre-Check: PR Metadata"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for lineage tracking

      - name: Check PR description completeness
        if: github.event_name == 'pull_request'
        env:
          # Pass PR body via env var to avoid shell expansion issues with special chars
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR description for governance requirements..."

          # Normalize CRLF to LF to handle Windows line endings
          NORMALIZED_BODY=$(echo "$PR_BODY" | tr -d '\r')

          # Acceptable section headers (case-insensitive, flexible matching)
          # Check for any of: Key Changes, Changes, Description, Overview, Summary
          HAS_DESCRIPTION=false
          HAS_CHANGES=false

          # Case-insensitive pattern matching
          if echo "$NORMALIZED_BODY" | grep -qiE "(description|overview|summary|what.*this.*pr)"; then
            HAS_DESCRIPTION=true
          fi

          if echo "$NORMALIZED_BODY" | grep -qiE "(changes|key changes|what changed|modifications)"; then
            HAS_CHANGES=true
          fi

          # Both description and changes must be present - REQUIRED
          if [ "$HAS_DESCRIPTION" = true ] && [ "$HAS_CHANGES" = true ]; then
            echo "âœ… PR description meets governance requirements"
          else
            echo "âŒ ALEX GOVERNANCE VIOLATION: PR description incomplete"
            echo "Required: Description/Overview section AND Changes/Key Changes section"
            echo "Current PR body length: ${#PR_BODY} chars"
            echo "HAS_DESCRIPTION: $HAS_DESCRIPTION"
            echo "HAS_CHANGES: $HAS_CHANGES"
            exit 1
          fi

      - name: Check for migration notes (if DB changes detected)
        run: |
          echo "Checking for database migrations..."

          # Check if DB models or migrations changed
          DB_CHANGES=$(git diff --name-only origin/main... | grep -E "(models|migrations|alembic)" || true)

          if [[ -n "$DB_CHANGES" ]]; then
            echo "Database changes detected: $DB_CHANGES"

            # Verify migration notes exist
            if [[ ! -f "docs/migrations/LATEST_MIGRATION.md" ]]; then
              echo "âŒ ALEX GOVERNANCE VIOLATION: DB changes require migration notes"
              echo "Create docs/migrations/LATEST_MIGRATION.md with migration details"
              exit 1
            fi

            echo "âœ… Migration notes found"
          else
            echo "No database changes detected"
          fi

  governance-checklist-validation:
    name: "ALEX Checklist: Validation Gate"
    runs-on: ubuntu-latest
    needs: governance-pre-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Verify checklist exists
        run: |
          echo "Checking for governance validation checklist..."

          if [[ ! -f "docs/governance/GOVERNANCE_VALIDATION_CHECKLIST_v1.yaml" ]]; then
            echo "âŒ ALEX GOVERNANCE VIOLATION: Checklist not found"
            echo "System cannot operate without governance checklist"
            exit 1
          fi

          if [[ ! -f "docs/governance/GOVERNANCE_VALIDATION_CHECKLIST_v1.md" ]]; then
            echo "âŒ ALEX GOVERNANCE VIOLATION: Checklist documentation not found"
            exit 1
          fi

          echo "âœ… Governance checklist files present"

      - name: Validate checklist YAML
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path

          checklist_path = Path("docs/governance/GOVERNANCE_VALIDATION_CHECKLIST_v1.yaml")

          try:
              with open(checklist_path) as f:
                  data = yaml.safe_load(f)
          except yaml.YAMLError as e:
              print(f"âŒ ALEX GOVERNANCE VIOLATION: Invalid checklist YAML")
              print(f"Error: {e}")
              sys.exit(1)

          # Required fields
          required = ["version", "minimum_compatible_version", "required_checks", "failure_mode"]
          missing = [f for f in required if f not in data]

          if missing:
              print(f"âŒ ALEX GOVERNANCE VIOLATION: Checklist missing fields: {missing}")
              sys.exit(1)

          # Verify version
          version = data.get("version", "0.0.0")
          min_version = data.get("minimum_compatible_version", "1.0.0")

          if version < min_version:
              print(f"âŒ ALEX GOVERNANCE VIOLATION: Checklist version {version} below minimum {min_version}")
              sys.exit(1)

          # Verify failure mode is DENY
          if data.get("failure_mode") != "DENY":
              print(f"âŒ ALEX GOVERNANCE VIOLATION: failure_mode must be DENY")
              sys.exit(1)

          # Verify checklist is locked
          if data.get("status") != "GOVERNANCE-LOCKED":
              print(f"âŒ ALEX GOVERNANCE VIOLATION: Checklist must be GOVERNANCE-LOCKED")
              sys.exit(1)

          print(f"âœ… Checklist validation passed (v{version})")
          EOF

      - name: Check protected path changes
        run: |
          echo "Checking for changes to protected governance paths..."

          # Get changed files
          CHANGED=$(git diff --name-only origin/main... 2>/dev/null || git diff --name-only HEAD~1 2>/dev/null || echo "")

          PROTECTED_PATTERNS=(
            "core/governance/"
            "gateway/alex_"
            "manifests/"
            "docs/governance/"
          )

          NEEDS_CHECKLIST_ACK=false
          for pattern in "${PROTECTED_PATTERNS[@]}"; do
            if echo "$CHANGED" | grep -q "$pattern"; then
              echo "âš ï¸  Protected path modified: $pattern"
              NEEDS_CHECKLIST_ACK=true
            fi
          done

          if [[ "$NEEDS_CHECKLIST_ACK" == "true" ]]; then
            echo ""
            echo "ğŸ“‹ Changes to governance paths detected"
            echo "Governance tests are REQUIRED for this PR"

            # Check if governance tests exist
            if [[ ! -d "tests/governance" ]]; then
              echo "âŒ ALEX GOVERNANCE VIOLATION: tests/governance/ directory missing"
              exit 1
            fi
          fi

          echo "âœ… Protected path check complete"

  # ============================================================================
  # ğŸŸ¢ DAN (GID-07) GOVERNANCE GUARD â€” PAC-DAN-01
  # Repo Scope + Immutability + Provenance
  # ============================================================================
  governance-guard:
    name: "DAN Governance Guard: Scope & Immutability"
    runs-on: ubuntu-latest
    needs: governance-pre-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate Build Provenance
        run: |
          echo "ğŸŸ¢ DAN (GID-07) â€” Generating build provenance..."
          python scripts/ci/generate_provenance.py --format header
          python scripts/ci/generate_provenance.py --format json --output provenance.json

      - name: Upload Provenance Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-provenance
          path: provenance.json

      - name: Check Repo Scope (Forbidden Artifacts)
        run: |
          echo "ğŸŸ¢ DAN (GID-07) â€” Checking repo scope..."
          python scripts/ci/check_repo_scope.py --json-output scope-report.json
        env:
          PYTHONPATH: .

      - name: Upload Scope Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scope-report
          path: scope-report.json

      - name: Check Governance Immutability
        run: |
          echo "ğŸŸ¢ DAN (GID-07) â€” Checking governance file immutability..."
          python scripts/ci/check_governance_immutability.py --json-output immutability-report.json
        env:
          PYTHONPATH: .
          GOVERNANCE_OVERRIDE: ${{ vars.GOVERNANCE_OVERRIDE }}
          GOVERNANCE_OVERRIDE_REASON: ${{ vars.GOVERNANCE_OVERRIDE_REASON }}

      - name: Upload Immutability Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: immutability-report
          path: immutability-report.json

      - name: Governance Guard Summary
        run: |
          echo "="
          echo "ğŸŸ¢ DAN (GID-07) â€” GOVERNANCE GUARD COMPLETE"
          echo "="
          echo "Repo integrity > velocity"

  governance-code-scan:
    name: "ALEX Code Scan: Rule Violations"
    runs-on: ubuntu-latest
    needs: [governance-pre-check, governance-checklist-validation, governance-guard]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ALEX governance scanner
        run: |
          pip install pyyaml
          pip install semgrep  # Static analysis tool

      - name: Rule 1 - Glass-Box ML Models Only
        run: |
          echo "Scanning for prohibited ML model types..."

          # Block black-box models
          VIOLATIONS=$(grep -r -E "(RandomForest|XGBClassifier|NeuralNetwork|MLPClassifier|KerasClassifier)" \
            --include="*.py" \
            --exclude-dir=".venv" \
            --exclude-dir="archived" \
            --exclude="*test*.py" \
            . || true)

          if [[ -n "$VIOLATIONS" ]]; then
            echo "âŒ ALEX RULE #1 VIOLATION: Black-box ML models detected"
            echo "$VIOLATIONS"
            echo ""
            echo "Only allowed: EBM, GAM, LogisticRegression, MonotoneGBDT"
            exit 1
          fi

          echo "âœ… Rule 1: No black-box models detected"

      - name: Rule 3 - Quantum-Safe Cryptography
        run: |
          echo "Scanning for quantum-vulnerable cryptography..."

          # Block RSA/ECDSA
          VIOLATIONS=$(grep -r -E "(from cryptography.hazmat.primitives.asymmetric import (rsa|dsa|ec)|from Crypto.PublicKey import (RSA|DSA)|import ecdsa)" \
            --include="*.py" \
            --exclude-dir=".venv" \
            --exclude-dir="archived" \
            --exclude-dir="tests" \
            . || true)

          if [[ -n "$VIOLATIONS" ]]; then
            echo "âŒ ALEX RULE #3 VIOLATION: Quantum-vulnerable cryptography detected"
            echo "$VIOLATIONS"
            echo ""
            echo "Use PQC libraries: pqcrypto.sign (SPHINCS+, Dilithium), pqcrypto.kem (Kyber)"
            exit 1
          fi

          echo "âœ… Rule 3: No quantum-vulnerable cryptography detected"

      - name: Rule 4 - No Unbounded Attack Surface
        run: |
          echo "Scanning for dangerous code patterns..."

          # Block eval, exec, unsafe yaml
          VIOLATIONS=$(grep -r -E "(eval\(|exec\(|yaml\.load\((?!.*SafeLoader)|__import__\(.*user)" \
            --include="*.py" \
            --exclude-dir=".venv" \
            --exclude-dir="archived" \
            . || true)

          if [[ -n "$VIOLATIONS" ]]; then
            echo "âŒ ALEX RULE #4 VIOLATION: Unbounded attack surface detected"
            echo "$VIOLATIONS"
            echo ""
            echo "Prohibited: eval(), exec(), yaml.load() without SafeLoader, dynamic imports"
            exit 1
          fi

          echo "âœ… Rule 4: No unbounded attack surface detected"

      - name: Rule 5 - Canonical DB Fields
        run: |
          echo "Scanning database models for canonical fields..."

          python3 << 'EOF'
          import re
          import sys
          from pathlib import Path

          # Required canonical fields
          REQUIRED_FIELDS = ['canonical_id', 'created_at', 'updated_at', 'version', 'source']

          # Find all SQLAlchemy models
          model_files = list(Path('.').rglob('*/models/*.py'))

          violations = []

          for model_file in model_files:
              if '.venv' in str(model_file) or 'archived' in str(model_file):
                  continue

              content = model_file.read_text()

              # Find class definitions
              class_pattern = r'class\s+(\w+)\(.*Base.*\):'
              classes = re.findall(class_pattern, content)

              for class_name in classes:
                  # Check if canonical fields exist
                  missing_fields = []
                  for field in REQUIRED_FIELDS:
                      if field not in content:
                          missing_fields.append(field)

                  if missing_fields and 'CanonicalBaseModel' not in content:
                      violations.append(f"{model_file}: {class_name} missing {missing_fields}")

          if violations:
              print("âŒ ALEX RULE #5 VIOLATION: DB models missing canonical fields")
              for v in violations:
                  print(f"  {v}")
              print("\nAll models must inherit from CanonicalBaseModel or include:")
              print(f"  {REQUIRED_FIELDS}")
              sys.exit(1)

          print("âœ… Rule 5: All models have canonical fields")
          EOF

      - name: Rule 10 - No Side-Effects in Import Paths
        run: |
          echo "Scanning for side-effects during imports..."

          # Check for heavy imports at module level
          VIOLATIONS=$(grep -r -E "(^MODEL\s*=\s*load_|^model\s*=\s*joblib\.load|^engine\s*=\s*create_engine)" \
            --include="*.py" \
            --exclude-dir=".venv" \
            --exclude-dir="archived" \
            --exclude="*test*.py" \
            . || true)

          if [[ -n "$VIOLATIONS" ]]; then
            echo "âŒ ALEX RULE #10 VIOLATION: Side-effects during import detected"
            echo "$VIOLATIONS"
            echo ""
            echo "Move heavy operations to startup events or lazy loading"
            exit 1
          fi

          echo "âœ… Rule 10: No import-time side-effects detected"

      - name: Rule 11 - Zero Silent Failures
        run: |
          echo "Scanning for silent exception handling..."

          # Block except: pass
          VIOLATIONS=$(grep -r -A1 "except" --include="*.py" \
            --exclude-dir=".venv" \
            --exclude-dir="archived" \
            . | grep -B1 "pass" || true)

          if [[ -n "$VIOLATIONS" ]]; then
            echo "âš ï¸  ALEX RULE #11 WARNING: Potential silent exception handling detected"
            echo "$VIOLATIONS"
            echo ""
            echo "Review exception handling - ensure logging and re-raising"
          fi

          echo "âœ… Rule 11: Silent failures check completed"

  governance-ml-check:
    name: "ALEX ML Governance: Model Metadata"
    runs-on: ubuntu-latest
    needs: governance-pre-check
    if: contains(github.event.pull_request.changed_files, 'chainiq-service') || contains(github.event.pull_request.changed_files, 'training')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check for model metadata
        run: |
          echo "Checking ML model governance..."

          # If training scripts changed, require metadata
          TRAINING_CHANGES=$(git diff --name-only origin/main... | grep -E "training/train_.*\.py" || true)

          if [[ -n "$TRAINING_CHANGES" ]]; then
            echo "Training scripts changed: $TRAINING_CHANGES"

            # Verify metadata files exist
            for script in $TRAINING_CHANGES; do
              model_name=$(basename "$script" .py | sed 's/train_//')
              metadata_file="models/${model_name}_metadata.json"

              if [[ ! -f "$metadata_file" ]]; then
                echo "âŒ ALEX ML GOVERNANCE VIOLATION: Missing metadata for $model_name"
                echo "Required: $metadata_file"
                echo "Metadata must include: model_type, monotonicity_constraints, calibration_metrics"
                exit 1
              fi

              # Validate metadata structure
              python3 << EOF
          import json
          import sys

          with open('$metadata_file') as f:
              metadata = json.load(f)

          required_keys = ['model_type', 'monotonicity_constraints', 'calibration_metrics', 'explainability_method', 'proof_pack_id']

          missing_keys = [k for k in required_keys if k not in metadata]

          if missing_keys:
              print(f"âŒ Metadata missing keys: {missing_keys}")
              sys.exit(1)

          # Validate model type
          allowed_types = ['EBM', 'GAM', 'LogisticRegression', 'MonotoneGBDT']
          if metadata['model_type'] not in allowed_types:
              print(f"âŒ Invalid model type: {metadata['model_type']}")
              print(f"Allowed: {allowed_types}")
              sys.exit(1)

          print(f"âœ… Metadata valid for {metadata['model_type']}")
          EOF
            done
          fi

          echo "âœ… ML governance check passed"

  governance-security-scan:
    name: "ALEX Security Scan: Vulnerabilities"
    runs-on: ubuntu-latest
    needs: governance-pre-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'

  # ============================================================================
  # ğŸ”µ ATLAS (GID-11) PAC LINT â€” PAC-BENSON-ATLAS-GOVERNANCE-HARDENING-01
  # Color Gateway Enforcement + PAC Structure Validation
  # ============================================================================
  governance-pac-lint:
    name: "ATLAS PAC Lint: Color Gateway Enforcement"
    runs-on: ubuntu-latest
    needs: governance-pre-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run PAC Linter (check mode)
        id: pac_lint
        run: |
          echo "ğŸ”µ ATLAS (GID-11) â€” Running PAC Linter..."
          echo ""
          
          # Run linter in check mode - exits non-zero on errors
          python tools/pac_linter.py --check --verbose 2>&1 | tee pac_lint_output.txt
          
          # Capture exit code
          LINT_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $LINT_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ PAC LINT FAILED â€” Merge blocked"
            echo "Fix violations before merging."
            exit 1
          fi
          
          echo ""
          echo "âœ… PAC lint passed â€” All governance checks satisfied"

      - name: Verify Color Gateway Compliance
        run: |
          echo "ğŸ”µ ATLAS (GID-11) â€” Verifying Color Gateway spec compliance..."
          
          # Check that color_gateway_spec.json exists and is valid
          if [ ! -f "docs/governance/color_gateway_spec.json" ]; then
            echo "âŒ GOVERNANCE ERROR: color_gateway_spec.json not found"
            exit 1
          fi
          
          # Validate JSON structure
          python3 << 'EOF'
          import json
          import sys
          
          with open('docs/governance/color_gateway_spec.json') as f:
              spec = json.load(f)
          
          # Required fields
          required = ['spec_version', 'lanes', 'rules']
          missing = [f for f in required if f not in spec]
          
          if missing:
              print(f"âŒ Color Gateway spec missing: {missing}")
              sys.exit(1)
          
          # Verify TEAL is reserved for GID-00
          teal = spec.get('lanes', {}).get('TEAL', {})
          if teal.get('reserved_gid') != 'GID-00':
              print("âŒ TEAL lane must be reserved for GID-00")
              sys.exit(1)
          
          # Verify rules are strict
          rules = spec.get('rules', {})
          strict_rules = [
              'require_executing_agent',
              'require_executing_gid',
              'require_executing_color',
              'deny_color_agent_mismatch',
              'deny_teal_as_executing'
          ]
          
          for rule in strict_rules:
              if not rules.get(rule, False):
                  print(f"âŒ Color Gateway rule must be enabled: {rule}")
                  sys.exit(1)
          
          print("âœ… Color Gateway spec validated")
          EOF

      - name: Check AGENT_REGISTRY.json integrity
        run: |
          echo "ğŸ”µ ATLAS (GID-11) â€” Verifying agent registry integrity..."
          
          if [ ! -f "docs/governance/AGENT_REGISTRY.json" ]; then
            echo "âŒ GOVERNANCE ERROR: AGENT_REGISTRY.json not found"
            exit 1
          fi
          
          python3 << 'EOF'
          import json
          import sys
          
          with open('docs/governance/AGENT_REGISTRY.json') as f:
              registry = json.load(f)
          
          agents = registry.get('agents', {})
          
          # Verify GID-00 through GID-11 exist
          gid_index = registry.get('gid_index', {})
          for i in range(12):
              gid = f"GID-{i:02d}"
              if gid not in gid_index:
                  print(f"âŒ Missing agent for {gid}")
                  sys.exit(1)
          
          # Verify BENSON is GID-00
          if gid_index.get('GID-00') != 'BENSON':
              print("âŒ GID-00 must be BENSON")
              sys.exit(1)
          
          # Verify TEAL is exclusive to GID-00
          for name, agent in agents.items():
              if agent.get('color') == 'TEAL' and agent.get('gid') != 'GID-00':
                  print(f"âŒ TEAL color reserved for GID-00, found on {name}")
                  sys.exit(1)
          
          print(f"âœ… Agent registry validated ({len(agents)} agents)")
          EOF

      - name: Upload PAC lint output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pac-lint-output
          path: pac_lint_output.txt

  # ============================================================================
  # ğŸ”µ ATLAS (GID-11) CORRECTION PACK HARD-GATE
  # PAC-ATLAS-G2-GOVERNANCE-CORRECTION-HARD-GATE-IMPLEMENTATION-01
  # 
  # FAIL-CLOSED. NO PARTIAL CHECKLISTS. NO MANUAL OVERRIDES. NO EXCEPTIONS.
  # ============================================================================
  governance-correction-pack-hardgate:
    name: "ATLAS Hard-Gate: Correction Pack Validation"
    runs-on: ubuntu-latest
    needs: governance-pac-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: ğŸ”’ HARD-GATE: Validate Correction Packs
        id: correction_validation
        run: |
          echo "ğŸ”µ ATLAS (GID-11) â€” CORRECTION PACK HARD-GATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "NO PARTIAL CHECKLISTS. NO MANUAL OVERRIDES. NO EXCEPTIONS."
          echo ""
          
          # Find all correction pack files in the changed files
          CHANGED_FILES=$(git diff --name-only origin/main... 2>/dev/null || git diff --name-only HEAD~1 2>/dev/null || echo "")
          
          # Pattern match for correction packs
          CORRECTION_PACKS=$(echo "$CHANGED_FILES" | grep -E "(CORRECTION|GOVERNANCE_CORRECTION)" || true)
          
          # Also scan for files containing correction markers
          ALL_CHANGED=$(echo "$CHANGED_FILES" | grep -E "\.(md|py|txt)$" || true)
          
          HARDGATE_FAILED=0
          VALIDATION_ERRORS=""
          
          for file in $ALL_CHANGED; do
            if [ -f "$file" ]; then
              # Check if file contains correction markers
              IS_CORRECTION=$(grep -cE "(CORRECTION|GOVERNANCE_CORRECTION|MODE: GOVERNANCE_CORRECTION|VIOLATIONS_ADDRESSED|correction_type:)" "$file" 2>/dev/null || echo "0")
              
              if [ "$IS_CORRECTION" -gt 0 ]; then
                echo "ğŸ” Detected correction pack: $file"
                
                # Run gate_pack.py validation
                if [ -f "ChainBridge/tools/governance/gate_pack.py" ]; then
                  VALIDATION_OUTPUT=$(python ChainBridge/tools/governance/gate_pack.py --validate "$file" 2>&1) || {
                    HARDGATE_FAILED=1
                    VALIDATION_ERRORS="$VALIDATION_ERRORS\nâŒ $file:\n$VALIDATION_OUTPUT\n"
                    
                    echo ""
                    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                    echo "â”‚ âŒ HARD-GATE FAILURE: $file"
                    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                    echo "$VALIDATION_OUTPUT"
                    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                    echo ""
                  }
                  
                  if [ $? -eq 0 ]; then
                    echo "âœ… Validated: $file"
                  fi
                else
                  echo "âš ï¸  gate_pack.py not found - running inline validation"
                  
                  # Inline Gold Standard Checklist validation
                  python3 << EOF
          import re
          import sys
          import yaml
          
          GOLD_STANDARD_KEYS = [
              "identity_correct", "agent_color_correct", "execution_lane_correct",
              "canonical_headers_present", "block_order_correct", "forbidden_actions_section_present",
              "scope_lock_present", "training_signal_present", "final_state_declared",
              "wrap_schema_valid", "no_extra_content", "no_scope_drift", "self_certification_present"
          ]
          
          with open("$file", "r") as f:
              content = f.read()
          
          # Check for GOLD_STANDARD_CHECKLIST block
          if "GOLD_STANDARD_CHECKLIST" not in content:
              print("âŒ G0_020: GOLD_STANDARD_CHECKLIST block missing")
              sys.exit(1)
          
          # Extract YAML block
          yaml_match = re.search(r'GOLD_STANDARD_CHECKLIST:\s*\n```yaml\n(.*?)\n```', content, re.DOTALL)
          if not yaml_match:
              print("âŒ G0_020: Unable to parse GOLD_STANDARD_CHECKLIST YAML block")
              sys.exit(1)
          
          try:
              checklist = yaml.safe_load(yaml_match.group(1))
          except yaml.YAMLError as e:
              print(f"âŒ G0_020: Invalid YAML in checklist: {e}")
              sys.exit(1)
          
          # Validate all keys present and checked
          errors = []
          for key in GOLD_STANDARD_KEYS:
              if key not in checklist:
                  errors.append(f"G0_024: Missing key '{key}'")
              elif not isinstance(checklist[key], dict) or not checklist[key].get("checked", False):
                  errors.append(f"G0_023: Key '{key}' is not checked: true")
          
          if errors:
              print("âŒ GOLD STANDARD CHECKLIST VALIDATION FAILED")
              for err in errors:
                  print(f"   {err}")
              sys.exit(1)
          
          # Check for self-certification
          if "SELF_CERTIFICATION" not in content:
              print("âŒ G0_021: SELF_CERTIFICATION block missing")
              sys.exit(1)
          
          # Check for VIOLATIONS_ADDRESSED
          if "VIOLATIONS_ADDRESSED" not in content:
              print("âŒ G0_022: VIOLATIONS_ADDRESSED section missing")
              sys.exit(1)
          
          print("âœ… All Gold Standard Checklist items verified")
          EOF
                  
                  if [ $? -ne 0 ]; then
                    HARDGATE_FAILED=1
                    VALIDATION_ERRORS="$VALIDATION_ERRORS\nâŒ $file: Gold Standard Checklist validation failed\n"
                  fi
                fi
              fi
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ $HARDGATE_FAILED -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
            echo "â”ƒ âŒ CORRECTION PACK HARD-GATE: FAILED                         â”ƒ"
            echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«"
            echo "â”ƒ ALL 13 Gold Standard Checklist items MUST be checked: true  â”ƒ"
            echo "â”ƒ NO PARTIAL CHECKLISTS. NO MANUAL OVERRIDES. NO EXCEPTIONS.  â”ƒ"
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
            echo ""
            echo "Training signal injected: NEGATIVE (G0_020-G0_024)"
            echo ""
            exit 1
          else
            echo "âœ… CORRECTION PACK HARD-GATE: PASSED"
            echo "All correction packs have valid Gold Standard Checklists"
          fi

      - name: Upload Correction Pack Validation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: correction-pack-validation
          path: |
            correction_validation_*.log

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for critical vulnerabilities
        run: |
          # Fail on CRITICAL vulnerabilities
          CRITICAL_COUNT=$(grep -c '"level": "error"' trivy-results.sarif || true)

          if [[ $CRITICAL_COUNT -gt 0 ]]; then
            echo "âŒ ALEX SECURITY VIOLATION: $CRITICAL_COUNT critical vulnerabilities found"
            echo "Review and patch before merging"
            exit 1
          fi

          echo "âœ… No critical vulnerabilities detected"

  governance-test-coverage:
    name: "ALEX Test Coverage: Minimum 80%"
    runs-on: ubuntu-latest
    needs: [governance-pre-check, governance-pac-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

          # Install project dependencies
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-report=term --cov-report=xml --cov-fail-under=80 || COVERAGE_FAILED=1

          if [[ $COVERAGE_FAILED -eq 1 ]]; then
            echo "âŒ ALEX GOVERNANCE VIOLATION: Test coverage below 80%"
            echo "Add more tests to meet governance requirements"
            exit 1
          fi

          echo "âœ… Test coverage meets 80% threshold"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  governance-chainpay-check:
    name: "ALEX ChainPay Governance: Settlement Rules"
    runs-on: ubuntu-latest
    needs: governance-pre-check
    if: contains(github.event.pull_request.changed_files, 'chainpay') || contains(github.event.pull_request.changed_files, 'settlement')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Rule 6 - Deterministic Settlement Check
        run: |
          echo "Checking ChainPay settlement logic..."

          # Verify no non-deterministic operations in settlement functions
          VIOLATIONS=$(grep -r -E "(random\.|datetime\.now\(\)|\.utcnow\(\))" \
            --include="*settlement*.py" \
            --include="*chainpay*.py" \
            --exclude-dir=".venv" \
            --exclude="*test*.py" \
            . || true)

          if [[ -n "$VIOLATIONS" ]]; then
            echo "âš ï¸  ALEX RULE #6 WARNING: Potential non-determinism in settlement logic"
            echo "$VIOLATIONS"
            echo ""
            echo "Settlement calculations must be pure functions"
            echo "Pass timestamps/randomness as parameters, don't generate internally"
          fi

          # Check for risk score requirement
          MISSING_RISK=$(grep -r "def.*settlement" --include="*.py" -A20 \
            --exclude-dir=".venv" \
            . | grep -v "risk_score" || true)

          if [[ -n "$MISSING_RISK" ]]; then
            echo "âš ï¸  ALEX RULE #6 WARNING: Settlement functions may be missing risk_score parameter"
            echo "All settlements must require ChainIQ risk scores"
          fi

          echo "âœ… ChainPay governance check completed"

  governance-report:
    name: "ALEX Governance Report"
    runs-on: ubuntu-latest
    needs: [governance-guard, governance-code-scan, governance-ml-check, governance-security-scan, governance-test-coverage, governance-chainpay-check, governance-correction-pack-hardgate]
    if: always()
    steps:
      - name: Download Provenance Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-provenance
          path: ./artifacts
        continue-on-error: true

      - name: Generate governance report
        run: |
          echo "# ALEX Governance Report" > governance-report.md
          echo "" >> governance-report.md
          echo "**PR:** ${{ github.event.pull_request.html_url }}" >> governance-report.md
          echo "**Branch:** ${{ github.head_ref }}" >> governance-report.md
          echo "**Author:** ${{ github.actor }}" >> governance-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> governance-report.md
          echo "" >> governance-report.md

          # Include provenance if available
          if [[ -f "./artifacts/provenance.json" ]]; then
            echo "## Build Provenance" >> governance-report.md
            echo '```json' >> governance-report.md
            cat ./artifacts/provenance.json >> governance-report.md
            echo '```' >> governance-report.md
            echo "" >> governance-report.md
          fi

          echo "## Governance Checks" >> governance-report.md
          echo "" >> governance-report.md
          echo "| Check | Status |" >> governance-report.md
          echo "|-------|--------|" >> governance-report.md
          echo "| Pre-Check (PR Metadata) | ${{ needs.governance-pre-check.result }} |" >> governance-report.md
          echo "| ğŸŸ¢ DAN Guard (Scope/Immutability) | ${{ needs.governance-guard.result }} |" >> governance-report.md
          echo "| Code Scan (Rule Violations) | ${{ needs.governance-code-scan.result }} |" >> governance-report.md
          echo "| ML Governance | ${{ needs.governance-ml-check.result }} |" >> governance-report.md
          echo "| Security Scan | ${{ needs.governance-security-scan.result }} |" >> governance-report.md
          echo "| Test Coverage | ${{ needs.governance-test-coverage.result }} |" >> governance-report.md
          echo "| ChainPay Governance | ${{ needs.governance-chainpay-check.result }} |" >> governance-report.md
          echo "| ğŸ”µ ATLAS Correction Pack Hard-Gate | ${{ needs.governance-correction-pack-hardgate.result }} |" >> governance-report.md
          echo "" >> governance-report.md
          echo "---" >> governance-report.md
          echo "*ALEX (GID-08) - Governance Above All â€¢ Integrity Before Speed â€¢ Proof Before Execution*" >> governance-report.md

          cat governance-report.md

      - name: Comment PR with report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('governance-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Final governance decision
        run: |
          # Check if any job failed
          if [[ "${{ needs.governance-guard.result }}" != "success" ]] || \
             [[ "${{ needs.governance-code-scan.result }}" != "success" ]] || \
             [[ "${{ needs.governance-security-scan.result }}" != "success" ]] || \
             [[ "${{ needs.governance-test-coverage.result }}" != "success" ]] || \
             [[ "${{ needs.governance-correction-pack-hardgate.result }}" != "success" ]]; then
            echo "âŒ ALEX GOVERNANCE: PR BLOCKED"
            echo "Fix violations before merging"
            
            # Check specifically for correction pack hard-gate failure
            if [[ "${{ needs.governance-correction-pack-hardgate.result }}" != "success" ]]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
              echo "â”ƒ ğŸ”µ ATLAS CORRECTION PACK HARD-GATE FAILURE                   â”ƒ"
              echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«"
              echo "â”ƒ Correction packs MUST have ALL 13 Gold Standard items        â”ƒ"
              echo "â”ƒ NO PARTIAL CHECKLISTS. NO MANUAL OVERRIDES. NO EXCEPTIONS.  â”ƒ"
              echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
            fi
            
            exit 1
          fi

          echo "âœ… ALEX GOVERNANCE: PR APPROVED"
          echo "All governance checks passed"
          echo "ğŸŸ¢ DAN (GID-07) â€” Repo integrity verified"
          echo "ğŸ”µ ATLAS (GID-11) â€” Correction pack hard-gate verified"
