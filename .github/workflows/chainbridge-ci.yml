name: ChainBridge Main Protection CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: 3.11

jobs:
  security-scan:
    name: Security & Vulnerability Assessment (CodeQL)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: chainbridge-security-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  code-quality:
    name: Code Quality & Standards
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: chainbridge-quality-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pre-commit pylint black flake8 mypy safety bandit

      - name: Normalize markdown fences (dry-run)
        run: |
          if [ -f scripts/normalize_markdown_fences.py ]; then \
            python scripts/normalize_markdown_fences.py; \
            git diff --exit-code || (echo 'Markdown fence normalization required. Run scripts/normalize_markdown_fences.py locally and commit.' && exit 1); \
          else \
            echo 'Normalization script not found'; \
          fi

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

      - name: Ruff lint and format
        run: |
          ruff check . --no-cache
          ruff format --check .

      - name: Code formatting check
        run: black --check --diff .

      - name: Linting
        run: pylint --rcfile=.pylintrc *.py || true

      - name: Type checking
        run: mypy --config-file=pyproject.toml . || true

      - name: Security audit
        run: |
          safety check || true
          bandit -r . -f json -o bandit-report.json || true

  configuration-validation:
    name: Configuration & Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate configuration files
        run: |
          python -c "import yaml; yaml.safe_load(open('config/config.yaml'))"
          python -c "import os,yaml; p='config.yaml'; print('root config exists' if os.path.exists(p) else 'no root config'); (yaml.safe_load(open(p)) if os.path.exists(p) else None); print('YAML root config validated if present')"

      - name: Schema validation
        run: |
          if [ -f scripts/validate_config_schema.py ]; then python scripts/validate_config_schema.py; else echo "No schema validator"; fi

  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run tests
        run: |
          if [ -f benson_rsi_bot.py ]; then python benson_rsi_bot.py --test; fi
          PYTEST_PATHS=""
          if [ -d tests ]; then PYTEST_PATHS="$PYTEST_PATHS tests/"; fi
          if [ -d ChainBridge/api/tests ]; then PYTEST_PATHS="$PYTEST_PATHS ChainBridge/api/tests"; fi
          if [ -n "$PYTEST_PATHS" ]; then
            pytest $PYTEST_PATHS -v --cov=ChainBridge --cov-report=xml
          else
            echo "No pytest suites discovered"
          fi

      - name: Upload coverage
        if: ${{ hashFiles('coverage.xml') != '' }}
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

  chainboard-ui-tests:
    name: ChainBoard UI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ChainBridge/chainboard-ui/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ChainBridge/chainboard-ui

      - name: Run vitest suite
        run: npm test -- --run
        working-directory: ChainBridge/chainboard-ui

  deployment-staging:
    name: Staging Deployment
    needs: [security-scan, code-quality, configuration-validation, unit-tests, chainboard-ui-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment"
          # Add staging deployment logic here

  deployment-production:
    name: Production Deployment
    needs: [security-scan, code-quality, configuration-validation, unit-tests, chainboard-ui-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Production deployment gate
        run: |
          echo "ðŸ”’ Production deployment requires manual approval"
          # Add production deployment logic here

  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Run fence normalizer & enforce cleanliness
        run: |
          if [ -f scripts/normalize_markdown_fences.py ]; then python scripts/normalize_markdown_fences.py; fi
          git diff --exit-code || (echo 'âŒ Unnormalized markdown fences detected. Run make docs-fix locally.' && exit 1)
      - name: Markdown lint
        run: |
          if command -v npx >/dev/null 2>&1; then \
            npx --yes markdownlint-cli '**/*.md'; \
          else \
            echo 'markdownlint skipped: npx missing'; \
          fi
