# =============================================================================
# ChainBridge Unified CI Pipeline v0.2
# =============================================================================
# Services covered:
#   - Backend API (api/ + core/)
#   - ChainBoard UI (ChainBridge/chainboard-ui/)
#   - ChainPay Service (ChainBridge/chainpay-service/)
#   - ChainIQ ML Service (ChainBridge/chainiq-service/)
#   - ChainFreight Service (ChainBridge/chainfreight-service/)
#
# Dan (GID-07) â€” DevOps & CI/CD Lead
# PAC Reference: PAC-DAN-CI-GOVERNANCE-HARDENING-02
# Last updated: 2024-12-19
# =============================================================================
# ENFORCEMENT: All jobs require activation-gate to pass first
# =============================================================================

name: ChainBridge Unified CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop, 'feature/**' ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

# =============================================================================
# JOBS
# =============================================================================

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GATE 0: Activation Gate (MANDATORY - MUST PASS FIRST)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  activation-gate:
    name: "ğŸš¦ DAN: Activation Gate (MANDATORY)"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ğŸš¦ CI Activation Gate (HARD FAIL)"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŸ¢ DAN (GID-07) â€” CI ACTIVATION GATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "PAC: PAC-DAN-CI-GOVERNANCE-HARDENING-02"
          echo "ENFORCEMENT: No CI job executes without activation"
          echo "BYPASS: NONE"
          echo ""
          python scripts/ci/activation_gate.py --base ${{ github.event.pull_request.base.ref || 'main' }} --verbose

  # ---------------------------------------------------------------------------
  # Security Scan (CodeQL) - requires activation-gate
  # ---------------------------------------------------------------------------
  security-scan:
    name: ğŸ”’ Security Scan (CodeQL)
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    concurrency:
      group: chainbridge-security-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript-typescript' ]
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ---------------------------------------------------------------------------
  # Code Quality (Linting, Formatting, Type Checking) - requires activation-gate
  # ---------------------------------------------------------------------------
  code-quality:
    name: ğŸ§¹ Code Quality & Standards
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    concurrency:
      group: chainbridge-quality-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-quality-${{ hashFiles('requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-quality-
            ${{ runner.os }}-pip-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Ruff lint
        run: ruff check . --no-cache || true

      - name: Ruff format check
        run: ruff format --check . || true

      - name: Black format check
        run: black --check --diff . || true

  # ---------------------------------------------------------------------------
  # Configuration Validation - requires activation-gate
  # ---------------------------------------------------------------------------
  config-validation:
    name: âš™ï¸ Config Validation
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate YAML configs
        run: |
          echo "Validating configuration files..."
          for cfg in config/config.yaml config.yaml; do
            if [ -f "$cfg" ]; then
              echo "  âœ“ Validating $cfg"
              python -c "import yaml; yaml.safe_load(open('$cfg'))"
            fi
          done
          echo "Configuration validation complete."

  # ---------------------------------------------------------------------------
  # Backend API Tests (api/ + core/ + root tests/) - requires activation-gate
  # ---------------------------------------------------------------------------
  backend-tests:
    name: ğŸ Backend API Tests
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-backend-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-backend-
            ${{ runner.os }}-pip-

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
          pip install pytest pytest-cov pytest-asyncio pytest-mock

      - name: Run pytest suite (root tests/)
        run: |
          if [ -d tests ]; then
            echo "Running pytest on tests/"
            pytest tests/ -v --tb=short --cov=api --cov=core --cov-report=xml --cov-report=term-missing
          else
            echo "No tests/ directory found"
          fi

      - name: Upload coverage
        if: success() && hashFiles('coverage.xml') != ''
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage

  # ---------------------------------------------------------------------------
  # ChainPay Service Tests - requires activation-gate
  # ---------------------------------------------------------------------------
  chainpay-tests:
    name: ğŸ’³ ChainPay Service Tests
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-chainpay-${{ hashFiles('ChainBridge/chainpay-service/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-chainpay-
            ${{ runner.os }}-pip-

      - name: Install ChainPay dependencies
        working-directory: ChainBridge/chainpay-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run ChainPay tests
        working-directory: ChainBridge/chainpay-service
        run: |
          echo "Running ChainPay test suite..."
          pytest tests/ -v --tb=short --cov=chainpay_service --cov=app --cov-report=xml --cov-report=term-missing

      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v4
        with:
          file: ChainBridge/chainpay-service/coverage.xml
          flags: chainpay
          name: chainpay-coverage

  # ---------------------------------------------------------------------------
  # ChainIQ ML Service Tests - requires activation-gate
  # ---------------------------------------------------------------------------
  chainiq-tests:
    name: ğŸ§  ChainIQ ML Service Tests
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-chainiq-${{ hashFiles('ChainBridge/chainiq-service/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-chainiq-
            ${{ runner.os }}-pip-

      - name: Install ChainIQ dependencies
        working-directory: ChainBridge/chainiq-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
          pip install httpx numpy scikit-learn sqlalchemy pydantic-settings

      - name: Run ChainIQ sanity checks
        working-directory: ChainBridge/chainiq-service
        run: |
          echo "Running ChainIQ sanity checks..."
          python -m compileall app/ -q
          if [ -d tests ]; then
            echo "Running ChainIQ pytest suite..."
            PYTHONPATH=. pytest tests/ -v --tb=short --ignore=tests/security/ --ignore=tests/drift/
          else
            echo "No ChainIQ tests directory â€” skeleton service validated via compileall"
          fi

  # ---------------------------------------------------------------------------
  # ChainFreight Service Tests - requires activation-gate
  # ---------------------------------------------------------------------------
  chainfreight-tests:
    name: ğŸšš ChainFreight Service Tests
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-chainfreight-${{ hashFiles('ChainBridge/chainfreight-service/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-chainfreight-
            ${{ runner.os }}-pip-

      - name: Install ChainFreight dependencies
        working-directory: ChainBridge/chainfreight-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest httpx

      - name: Run ChainFreight sanity checks
        working-directory: ChainBridge/chainfreight-service
        run: |
          echo "Running ChainFreight sanity checks..."
          # Syntax validation
          python -m compileall app/ -q
          # TODO(Dan): Add ChainFreight test suite when service is implemented
          if [ -d tests ] && [ "$(ls -A tests/*.py 2>/dev/null)" ]; then
            pytest tests/ -v --tb=short
          else
            echo "âš ï¸ No ChainFreight tests yet â€” skeleton service validated via compileall"
          fi

  # ---------------------------------------------------------------------------
  # ChainBoard UI Tests (React/TypeScript/Vite) - requires activation-gate
  # ---------------------------------------------------------------------------
  chainboard-ui-tests:
    name: ğŸ¨ ChainBoard UI Tests
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Detect ChainBoard UI lockfile
        id: lockfile
        shell: bash
        run: |
          if [ -f "ChainBridge/chainboard-ui/package-lock.json" ]; then
            echo "has_lockfile=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_lockfile=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js (cached)
        if: steps.lockfile.outputs.has_lockfile == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ChainBridge/chainboard-ui/package-lock.json

      - name: Setup Node.js (no cache)
        if: steps.lockfile.outputs.has_lockfile != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ChainBridge/chainboard-ui
        run: npm ci

      - name: Type check
        working-directory: ChainBridge/chainboard-ui
        run: npm run type-check

      - name: Lint
        working-directory: ChainBridge/chainboard-ui
        run: npm run lint

      - name: Build
        working-directory: ChainBridge/chainboard-ui
        run: npm run build

      - name: Run Vitest suite
        working-directory: ChainBridge/chainboard-ui
        run: npm test -- --run --reporter=verbose

  # ---------------------------------------------------------------------------
  # Prompt Regression (ChainIQ) - requires activation-gate
  # ---------------------------------------------------------------------------
  prompt-regression:
    name: ğŸ¤– Prompt Regression (ChainIQ)
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 15
    env:
      PROMPTFOO_OPENAI_API_KEY: ${{ secrets.PROMPTFOO_OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure OpenAI key present
        run: |
          if [ -z "${PROMPTFOO_OPENAI_API_KEY}" ]; then
            echo "PROMPTFOO_OPENAI_API_KEY is required for prompt regression checks"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install promptfoo
        run: npm install -g promptfoo@latest

      - name: Run ChainIQ golden set
        run: |
          mkdir -p .promptfoo/chain_iq
          promptfoo eval -c prompts/promptfooconfig.chain_iq.yaml \
            --format junit \
            --output .promptfoo/chain_iq/results.xml

      - name: Upload prompt regression artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prompt-regression-chainiq
          path: .promptfoo/chain_iq
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Gateway Policy Enforcement (prod simulation) - requires activation-gate
  # ---------------------------------------------------------------------------
  gateway-policy:
    name: ğŸ›¡ï¸ Gateway Policy Check
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Run gateway policy check (prod defaults)
        env:
          GATEWAY_ENV: prod
          GATEWAY_CORS_ORIGINS: ${{ secrets.GATEWAY_CORS_ORIGINS || 'https://chainbridge.app,https://dashboard.chainbridge.app' }}
          GATEWAY_ALLOW_DYNAMIC_MODULES: ${{ vars.GATEWAY_ALLOW_DYNAMIC_MODULES || 'false' }}
          GATEWAY_REQUIRE_PDO: ${{ vars.GATEWAY_REQUIRE_PDO || 'true' }}
        run: python scripts/ci/gateway_policy_check.py

  # ---------------------------------------------------------------------------
  # Documentation Quality - requires activation-gate
  # ---------------------------------------------------------------------------
  docs-quality:
    name: ğŸ“š Documentation Quality
    runs-on: ubuntu-latest
    needs: activation-gate  # MANDATORY: Must pass activation gate first
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run markdown fence normalizer
        run: |
          if [ -f scripts/normalize_markdown_fences.py ]; then
            python scripts/normalize_markdown_fences.py
            git diff --exit-code || echo "âš ï¸ Markdown fences need normalization (non-blocking)"
          fi

  # ---------------------------------------------------------------------------
  # CI Summary Gate - includes activation-gate
  # ---------------------------------------------------------------------------
  ci-gate:
    name: âœ… CI Gate (All Checks)
    runs-on: ubuntu-latest
    needs:
      - activation-gate
      - security-scan
      - code-quality
      - config-validation
      - backend-tests
      - chainpay-tests
      - chainiq-tests
      - chainfreight-tests
      - chainboard-ui-tests
      - prompt-regression
      - gateway-policy
      - docs-quality
    if: always()
    steps:
      - name: Check all job results
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŸ¢ DAN (GID-07) â€” CI PIPELINE SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Activation Gate:   ${{ needs.activation-gate.result }}"
          echo "Security Scan:     ${{ needs.security-scan.result }}"
          echo "Code Quality:      ${{ needs.code-quality.result }}"
          echo "Config Validation: ${{ needs.config-validation.result }}"
          echo "Backend Tests:     ${{ needs.backend-tests.result }}"
          echo "ChainPay Tests:    ${{ needs.chainpay-tests.result }}"
          echo "ChainIQ Tests:     ${{ needs.chainiq-tests.result }}"
          echo "ChainFreight Tests: ${{ needs.chainfreight-tests.result }}"
          echo "ChainBoard UI:     ${{ needs.chainboard-ui-tests.result }}"
          echo "Prompt Regression: ${{ needs.prompt-regression.result }}"
          echo "Gateway Policy:    ${{ needs.gateway-policy.result }}"
          echo "Docs Quality:      ${{ needs.docs-quality.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # CRITICAL: Fail if activation gate failed
          if [[ "${{ needs.activation-gate.result }}" != "success" ]]; then
            echo "âŒ DENIED: Activation Gate failed â€” NO BYPASS"
            exit 1
          fi

          # Fail if any critical job failed
          if [[ "${{ needs.backend-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.chainpay-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.chainiq-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.chainboard-ui-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.prompt-regression.result }}" == "failure" ]] || \
             [[ "${{ needs.gateway-policy.result }}" == "failure" ]]; then
            echo "âŒ Critical job(s) failed!"
            exit 1
          fi

          echo "âœ… All critical checks passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŸ¢ END â€” DAN (GID-07) â€” CI GATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ---------------------------------------------------------------------------
  # Staging Deployment (develop branch only)
  # ---------------------------------------------------------------------------
  deployment-staging:
    name: ğŸš€ Staging Deployment
    needs: ci-gate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && needs.ci-gate.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # TODO(Dan): Add staging deployment logic (docker-compose, k8s, etc.)

  # ---------------------------------------------------------------------------
  # Production Deployment (main branch only)
  # ---------------------------------------------------------------------------
  deployment-production:
    name: ğŸ”’ Production Deployment
    needs: ci-gate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.ci-gate.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - name: Production deployment gate
        run: |
          echo "ğŸ”’ Production deployment requires manual approval"
          # TODO(Dan): Add production deployment logic with approval gates
