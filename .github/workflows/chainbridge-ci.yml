name: ChainBridge Platform CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ChainBridge/**'
      - 'chainboard-service/**'
      - 'chainfreight-service/**'
      - 'chainpay-service/**'
      - 'chainiq-service/**'
      - 'proofpacks/**'
      - 'k8s/**'
      - 'docker-compose.yml'
      - 'Dockerfile*'
      - '.github/workflows/chainbridge-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ChainBridge/**'
      - 'chainboard-service/**'
      - 'chainfreight-service/**'
      - 'chainpay-service/**'
      - 'chainiq-service/**'
      - 'proofpacks/**'
      - 'k8s/**'
      - 'docker-compose.yml'
      - 'Dockerfile*'
      - '.github/workflows/chainbridge-ci.yml'

env:
  PYTHON_VERSION: 3.11

jobs:
  security-scan:
    name: Security & Vulnerability Assessment (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  service-tests:
    name: ChainBridge Service Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [chainboard, chainiq, chainfreight, chainpay]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies for ${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          if [ -f ChainBridge/${{ matrix.service }}-service/requirements.txt ]; then
            pip install -r ChainBridge/${{ matrix.service }}-service/requirements.txt
          fi
          pip install pytest pytest-cov pytest-mock
      
      - name: Run ${{ matrix.service }} tests
        run: |
          if [ -d ChainBridge/${{ matrix.service }}-service/tests ]; then
            cd ChainBridge/${{ matrix.service }}-service
            pytest tests/ -v --cov=app --cov-report=xml
          else
            echo "No tests directory for ${{ matrix.service }}"
          fi
      
      - name: Upload coverage
        if: ${{ hashFiles(format('ChainBridge/{0}-service/coverage.xml', matrix.service)) != '' }}
        uses: codecov/codecov-action@v3
        with:
          file: ChainBridge/${{ matrix.service }}-service/coverage.xml
          flags: ${{ matrix.service }}

  integration-tests:
    name: ChainBridge Integration Tests
    runs-on: ubuntu-latest
    needs: service-tests
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-enterprise.txt
          pip install pytest pytest-cov pytest-mock
      
      - name: Run integration tests
        run: |
          if [ -d ChainBridge/tests ]; then
            pytest ChainBridge/tests/ -v --cov=ChainBridge --cov-report=xml
          else
            echo "No ChainBridge integration tests directory"
          fi

  code-quality:
    name: Code Quality & Standards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff pylint mypy safety bandit
      
      - name: Code formatting check
        run: black --check --diff ChainBridge/
      
      - name: Linting with Ruff
        run: ruff check ChainBridge/
      
      - name: Type checking
        run: mypy ChainBridge/ || true
      
      - name: Security audit
        run: |
          safety check || true
          bandit -r ChainBridge/ -f json -o chainbridge-bandit-report.json || true

  docker-build:
    name: Docker Build Verification
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [chainboard, chainiq, chainfreight, chainpay]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }} Docker image
        run: |
          if [ -f ChainBridge/${{ matrix.service }}-service/Dockerfile ]; then
            docker build -t ${{ matrix.service }}:test -f ChainBridge/${{ matrix.service }}-service/Dockerfile .
          else
            echo "No Dockerfile for ${{ matrix.service }}"
          fi

  deployment-staging:
    name: Staging Deployment
    needs: [security-scan, service-tests, integration-tests, code-quality, docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying ChainBridge to staging environment"
          # Add staging deployment logic here

  deployment-production:
    name: Production Deployment
    needs: [security-scan, service-tests, integration-tests, code-quality, docker-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Production deployment gate
        run: |
          echo "ðŸ”’ ChainBridge production deployment requires manual approval"
          # Add production deployment logic here
