name: Terraform Infrastructure CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - 'infrastructure/**'
      - '*.tf'
      - '*.tfvars'
      - '.github/workflows/terraform-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - 'infrastructure/**'
      - '*.tf'
      - '*.tfvars'
      - '.github/workflows/terraform-ci.yml'

env:
  TERRAFORM_VERSION: 1.5.0

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Format Check
        run: |
          if [ -d terraform ] || [ -d infrastructure ] || ls *.tf 2>/dev/null; then
            terraform fmt -check -recursive .
          else
            echo "No Terraform files found, skipping format check"
          fi
      
      - name: Terraform Init
        run: |
          if [ -d terraform ]; then
            cd terraform && terraform init -backend=false
          elif [ -d infrastructure ]; then
            cd infrastructure && terraform init -backend=false
          else
            echo "No Terraform directory found, skipping init"
          fi
      
      - name: Terraform Validate
        run: |
          if [ -d terraform ]; then
            cd terraform && terraform validate
          elif [ -d infrastructure ]; then
            cd infrastructure && terraform validate
          else
            echo "No Terraform directory found, skipping validate"
          fi

  tfsec-scan:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          additional_args: --force-all-dirs

  checkov-scan:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          soft_fail: true
          framework: terraform

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [terraform-validate, tfsec-scan]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Plan
        run: |
          if [ -d terraform ]; then
            cd terraform
            terraform init -backend=false
            terraform plan -out=tfplan
          elif [ -d infrastructure ]; then
            cd infrastructure
            terraform init -backend=false
            terraform plan -out=tfplan
          else
            echo "No Terraform directory found, skipping plan"
          fi

  terraform-apply-staging:
    name: Apply to Staging
    runs-on: ubuntu-latest
    needs: [terraform-validate, tfsec-scan, checkov-scan]
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Apply to Staging
        run: |
          echo "ðŸš€ Applying Terraform to staging environment"
          # Add staging apply logic here with proper backend configuration

  terraform-apply-production:
    name: Apply to Production
    runs-on: ubuntu-latest
    needs: [terraform-validate, tfsec-scan, checkov-scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Apply to Production
        run: |
          echo "ðŸ”’ Production Terraform apply requires manual approval"
          # Add production apply logic here with proper backend configuration
