#!/bin/sh
#
# ════════════════════════════════════════════════════════════════════
# 🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
# ATLAS — GID-11 — BUILD / REPOSITORY ENFORCEMENT
# PAC-BENSON-ATLAS-GOVERNANCE-HARDENING-01
# ════════════════════════════════════════════════════════════════════
#
# Pre-commit hook: Governance enforcement at commit boundary
#
# EXECUTING AGENT: ATLAS (GID-11)
# EXECUTING COLOR: 🔵 BLUE
#
# This hook BLOCKS commits that contain governance violations.
# No bypass flags. No overrides. Fail-closed.
#
# ENFORCEMENT:
#   - PAC format validation
#   - GID/agent correctness
#   - Color lane compliance
#   - Hybrid artifact detection
#
# ════════════════════════════════════════════════════════════════════

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}════════════════════════════════════════════════════════════════════${NC}"
echo "${BLUE}🔵 ATLAS GOVERNANCE GATE — Pre-commit Check${NC}"
echo "${BLUE}════════════════════════════════════════════════════════════════════${NC}"

# Get repository root
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$REPO_ROOT" ]; then
    echo "${RED}❌ ERROR: Not in a git repository${NC}"
    exit 1
fi

cd "$REPO_ROOT"

# Check if pac_linter.py exists
PAC_LINTER="$REPO_ROOT/tools/pac_linter.py"
if [ ! -f "$PAC_LINTER" ]; then
    echo "${RED}❌ ERROR: PAC linter not found at $PAC_LINTER${NC}"
    echo "${RED}   Governance enforcement cannot proceed.${NC}"
    exit 1
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}✅ No files staged. Skipping governance check.${NC}"
    exit 0
fi

echo ""
echo "Checking staged files for governance compliance..."
echo ""

# =============================================================================
# TASK 1: Run PAC linter on staged Python files
# =============================================================================

STAGED_PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)

PAC_VIOLATIONS=0
if [ -n "$STAGED_PY_FILES" ]; then
    echo "${BLUE}[1/5] Running PAC linter on staged Python files...${NC}"
    
    # Create temp file list
    TEMP_FILE_LIST=$(mktemp)
    echo "$STAGED_PY_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            echo "$REPO_ROOT/$file" >> "$TEMP_FILE_LIST"
        fi
    done
    
    # Run linter on each file
    LINT_OUTPUT=$(mktemp)
    LINT_FAILED=0
    
    for file in $STAGED_PY_FILES; do
        if [ -f "$file" ]; then
            # Run linter in check mode
            if ! python3 "$PAC_LINTER" "$REPO_ROOT/$file" --check 2>&1 >> "$LINT_OUTPUT"; then
                LINT_FAILED=1
            fi
        fi
    done
    
    if [ $LINT_FAILED -eq 1 ]; then
        echo "${RED}❌ PAC lint violations detected:${NC}"
        cat "$LINT_OUTPUT"
        PAC_VIOLATIONS=1
    else
        echo "${GREEN}   ✅ PAC lint passed${NC}"
    fi
    
    rm -f "$TEMP_FILE_LIST" "$LINT_OUTPUT"
else
    echo "${BLUE}[1/5] No Python files staged. Skipping PAC lint.${NC}"
fi

# =============================================================================
# TASK 2: Check for EXECUTING AGENT / EXECUTING COLOR in PAC-like files
# =============================================================================

echo ""
echo "${BLUE}[2/5] Checking PAC structure requirements...${NC}"

STRUCTURE_VIOLATIONS=0
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        # Check if file looks like a PAC (has PAC- reference and governance markers)
        if grep -q "PAC-" "$file" 2>/dev/null; then
            # Check for required fields
            HAS_INDICATORS=$(grep -cE "(EXECUTING AGENT|EXECUTING COLOR|END OF PAC)" "$file" 2>/dev/null || echo "0")
            
            if [ "$HAS_INDICATORS" -gt 0 ]; then
                # This is a PAC file - verify structure
                HAS_AGENT=$(grep -c "EXECUTING AGENT" "$file" 2>/dev/null || echo "0")
                HAS_COLOR=$(grep -c "EXECUTING COLOR" "$file" 2>/dev/null || echo "0")
                
                if [ "$HAS_AGENT" -eq 0 ]; then
                    echo "${RED}   ❌ $file: Missing EXECUTING AGENT${NC}"
                    STRUCTURE_VIOLATIONS=1
                fi
                
                if [ "$HAS_COLOR" -eq 0 ]; then
                    echo "${RED}   ❌ $file: Missing EXECUTING COLOR${NC}"
                    STRUCTURE_VIOLATIONS=1
                fi
            fi
        fi
    fi
done

if [ $STRUCTURE_VIOLATIONS -eq 0 ]; then
    echo "${GREEN}   ✅ PAC structure check passed${NC}"
fi

# =============================================================================
# TASK 3: Check for GID/Color mismatch
# =============================================================================

echo ""
echo "${BLUE}[3/5] Checking GID/Color alignment...${NC}"

GID_COLOR_VIOLATIONS=0
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        # Extract EXECUTING AGENT line
        AGENT_LINE=$(grep -i "EXECUTING AGENT" "$file" 2>/dev/null | head -1 || true)
        COLOR_LINE=$(grep -i "EXECUTING COLOR" "$file" 2>/dev/null | head -1 || true)
        
        if [ -n "$AGENT_LINE" ] && [ -n "$COLOR_LINE" ]; then
            # Check for TEAL usage by non-GID-00
            if echo "$COLOR_LINE" | grep -qi "TEAL"; then
                # TEAL detected - verify it's GID-00
                if ! echo "$AGENT_LINE" | grep -q "GID-00"; then
                    GID_VAL=$(echo "$AGENT_LINE" | grep -oE "GID-[0-9]+" | head -1 || echo "unknown")
                    echo "${RED}   ❌ $file: TEAL color reserved for GID-00, found $GID_VAL${NC}"
                    GID_COLOR_VIOLATIONS=1
                fi
            fi
        fi
    fi
done

if [ $GID_COLOR_VIOLATIONS -eq 0 ]; then
    echo "${GREEN}   ✅ GID/Color alignment check passed${NC}"
fi

# =============================================================================
# TASK 4: Check for hybrid artifacts (PAC + Evidence mixed)
# =============================================================================

echo ""
echo "${BLUE}[4/5] Checking for hybrid artifact violations...${NC}"

HYBRID_VIOLATIONS=0
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        # A file should not contain both PAC and EVIDENCE markers
        HAS_PAC=$(grep -c "PAC-" "$file" 2>/dev/null || echo "0")
        HAS_EVIDENCE=$(grep -cE "(EVIDENCE REPORT|EVIDENCE-)" "$file" 2>/dev/null || echo "0")
        
        if [ "$HAS_PAC" -gt 0 ] && [ "$HAS_EVIDENCE" -gt 0 ]; then
            # Check if it's just referencing a PAC in evidence (allowed)
            # vs actually mixing PAC definition with evidence (not allowed)
            HAS_PAC_HEADER=$(grep -cE "^(#|//|\*|'''|\"\"\").*PAC-.*-[0-9]+" "$file" 2>/dev/null || echo "0")
            HAS_EVIDENCE_HEADER=$(grep -cE "EVIDENCE REPORT" "$file" 2>/dev/null || echo "0")
            
            if [ "$HAS_PAC_HEADER" -gt 0 ] && [ "$HAS_EVIDENCE_HEADER" -gt 0 ]; then
                echo "${RED}   ❌ $file: Hybrid artifact detected (PAC + Evidence mixed)${NC}"
                HYBRID_VIOLATIONS=1
            fi
        fi
    fi
done

if [ $HYBRID_VIOLATIONS -eq 0 ]; then
    echo "${GREEN}   ✅ No hybrid artifacts detected${NC}"
fi

# =============================================================================
# TASK 5: HARD-GATE — Correction Pack Gold Standard Checklist Validation
# PAC-ATLAS-G2-GOVERNANCE-CORRECTION-HARD-GATE-IMPLEMENTATION-01
# =============================================================================

echo ""
echo "${BLUE}[5/5] 🔒 HARD-GATE: Correction Pack Validation...${NC}"

CORRECTION_VIOLATIONS=0
GATE_PACK="$REPO_ROOT/ChainBridge/tools/governance/gate_pack.py"

# Find staged PAC/WRAP files
STAGED_PAC_WRAPS=$(echo "$STAGED_FILES" | grep -E "(PAC-|WRAP-).*\.(md|py|txt)$" || true)

if [ -n "$STAGED_PAC_WRAPS" ] && [ -f "$GATE_PACK" ]; then
    for file in $STAGED_PAC_WRAPS; do
        if [ -f "$file" ]; then
            # Check if this is a correction pack
            IS_CORRECTION=$(grep -cE "(CORRECTION|GOVERNANCE_CORRECTION|MODE: GOVERNANCE_CORRECTION|VIOLATIONS_ADDRESSED|correction_type:)" "$file" 2>/dev/null || echo "0")
            
            if [ "$IS_CORRECTION" -gt 0 ]; then
                echo "${YELLOW}   🔍 Detected correction pack: $file${NC}"
                
                # Run gate_pack.py validation
                VALIDATION_OUTPUT=$(mktemp)
                if ! python3 "$GATE_PACK" --validate "$REPO_ROOT/$file" 2>&1 > "$VALIDATION_OUTPUT"; then
                    echo "${RED}   ❌ HARD-GATE FAILURE: $file${NC}"
                    cat "$VALIDATION_OUTPUT"
                    CORRECTION_VIOLATIONS=1
                    
                    # Check for specific Gold Standard Checklist failures
                    if grep -qE "(G0_020|G0_021|G0_022|G0_023|G0_024)" "$VALIDATION_OUTPUT" 2>/dev/null; then
                        echo ""
                        echo "${RED}   ┌──────────────────────────────────────────────────────────────┐${NC}"
                        echo "${RED}   │ GOLD STANDARD CHECKLIST VIOLATION DETECTED                   │${NC}"
                        echo "${RED}   │ Correction packs MUST have ALL 13 checklist items checked.   │${NC}"
                        echo "${RED}   │ NO PARTIAL CHECKLISTS. NO MANUAL OVERRIDES. NO EXCEPTIONS.   │${NC}"
                        echo "${RED}   └──────────────────────────────────────────────────────────────┘${NC}"
                    fi
                else
                    echo "${GREEN}   ✅ Correction pack validated: $file${NC}"
                fi
                rm -f "$VALIDATION_OUTPUT"
            fi
        fi
    done
else
    echo "${GREEN}   ✅ No correction packs staged (or gate_pack.py not found)${NC}"
fi

if [ $CORRECTION_VIOLATIONS -gt 0 ]; then
    echo ""
    echo "${RED}   ═══════════════════════════════════════════════════════════════${NC}"
    echo "${RED}   CORRECTION PACK HARD-GATE: FAILED${NC}"
    echo "${RED}   Training signal injected: NEGATIVE (G0_020-G0_024)${NC}"
    echo "${RED}   ═══════════════════════════════════════════════════════════════${NC}"
fi

# =============================================================================
# FINAL VERDICT
# =============================================================================

echo ""
echo "${BLUE}════════════════════════════════════════════════════════════════════${NC}"

TOTAL_VIOLATIONS=$((PAC_VIOLATIONS + STRUCTURE_VIOLATIONS + GID_COLOR_VIOLATIONS + HYBRID_VIOLATIONS + CORRECTION_VIOLATIONS))

if [ $TOTAL_VIOLATIONS -gt 0 ]; then
    echo "${RED}❌ GOVERNANCE CHECK FAILED${NC}"
    echo "${RED}   $TOTAL_VIOLATIONS violation category(ies) detected.${NC}"
    echo "${RED}   Commit blocked. Fix violations and retry.${NC}"
    echo ""
    echo "${YELLOW}   No bypass flags available. Governance is non-negotiable.${NC}"
    echo "${BLUE}════════════════════════════════════════════════════════════════════${NC}"
    exit 1
else
    echo "${GREEN}✅ GOVERNANCE CHECK PASSED${NC}"
    echo "${GREEN}   All checks passed. Commit permitted.${NC}"
    echo "${BLUE}════════════════════════════════════════════════════════════════════${NC}"
    exit 0
fi

# ════════════════════════════════════════════════════════════════════
# 🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
# END OF HOOK — ATLAS (GID-11 / 🔵 BLUE)
# ════════════════════════════════════════════════════════════════════
