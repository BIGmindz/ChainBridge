# ============================================================================
# CHAINBRIDGE TEST GOVERNANCE LAYER (TGL) - DOCKER COMPOSE
# Hermetic Test Execution Environment
# ============================================================================
#
# AUTHORITY: JEFFREY (GID-CONST-01) Constitutional Architect
# IMPLEMENTER: DAN (GID-07) Infrastructure Specialist
# GOVERNANCE: LAW-tier (Fail-Closed)
# PAC: PAC-INFRA-P710
#
# PURPOSE:
# Orchestrate sovereign-runner container for TGL-compliant test execution
# with network isolation, resource limits, and manifest generation.
#
# USAGE:
#   docker-compose -f docker-compose.tgl.yml build
#   docker-compose -f docker-compose.tgl.yml up --abort-on-container-exit
#   docker-compose -f docker-compose.tgl.yml down
#
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # SOVEREIGN RUNNER: Hermetic Test Execution Environment
  # ==========================================================================
  sovereign-runner:
    build:
      context: .
      dockerfile: Dockerfile.sovereign
      args:
        RUNNER_VERSION: "1.0.0"
    image: chainbridge/sovereign-runner:v1.0.0
    container_name: chainbridge-sovereign-runner
    
    # Non-root user execution (UID 1000 - chainbridge)
    user: "1000:1000"
    
    # Environment variables
    environment:
      - TGL_MODE=production
      - AGENT_GID=GID-04
      - RUNNER_VERSION=1.0.0
      - PYTHONUNBUFFERED=1
      - GIT_COMMIT_HASH=${GIT_COMMIT_HASH:-unknown}
    
    # Volume mounts (for test results, manifests, coverage)
    volumes:
      # Output directories (read-write)
      - ./manifests:/app/manifests
      - ./coverage:/app/coverage
      - ./logs:/app/logs
      
      # Signing key (read-only secret)
      # Uncomment and configure when signing key is available
      # - ./keys/agent_signing_key.pem:/app/keys/agent_signing_key.pem:ro
    
    # Network configuration: Isolated with egress whitelist
    networks:
      - tgl-isolated
    
    # Resource limits (prevent resource exhaustion)
    deploy:
      resources:
        limits:
          cpus: '2.0'      # Max 2 CPU cores
          memory: 4G       # Max 4GB RAM
        reservations:
          cpus: '1.0'      # Reserve 1 CPU core
          memory: 2G       # Reserve 2GB RAM
    
    # Security options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    
    # Read-only root filesystem (enhanced security)
    # Writable volumes defined above
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=512m
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    # Restart policy: No restart (one-shot execution)
    restart: "no"
    
    # Command override (run specific tests)
    # Default: Run all tests with coverage
    # Override: docker-compose -f docker-compose.tgl.yml run sovereign-runner pytest tests/test_scram.py
    command:
      - pytest
      - --cov=/app
      - --cov-report=json:/app/coverage/coverage.json
      - --cov-report=term
      - --timeout=300
      - -v
      - tests/

  # ==========================================================================
  # NETWORK CONFIGURATION: Isolated with Egress Whitelist
  # ==========================================================================
networks:
  tgl-isolated:
    driver: bridge
    internal: true  # No external network access by default
    ipam:
      config:
        - subnet: 172.25.0.0/16
    # Note: For external package downloads during build, use multi-stage builds
    # Runtime: No external network required (hermetic seal)

# ==========================================================================
# VOLUMES: Persistent Storage for Manifests and Coverage
# ==========================================================================
volumes:
  manifests:
    driver: local
  coverage:
    driver: local
  logs:
    driver: local

# ============================================================================
# SECURITY HARDENING CHECKLIST (SAM GID-06 Audit)
# ============================================================================
#
# [✓] Non-root user execution (user: 1000:1000)
# [✓] Read-only root filesystem (read_only: true)
# [✓] No privilege escalation (no-new-privileges:true)
# [✓] Resource limits enforced (CPU, memory)
# [✓] Isolated network (internal: true)
# [✓] Minimal writable volumes (manifests, coverage, logs)
# [✓] No shell access (entrypoint enforces)
# [✓] Immutable image (hash verification)
# [✓] Health checks enabled
# [✓] No automatic restarts (one-shot execution)
#
# REMAINING RISKS:
# [ ] Signing key security (mount as Docker secret in production)
# [ ] Base image drift (monitor debian:bullseye-slim hash)
# [ ] Network egress (currently fully isolated, may need PyPI access for builds)
#
# ============================================================================

# ============================================================================
# ATTESTATION
# ============================================================================
#
# "This docker-compose configuration embodies the Sovereign Runner doctrine:
# The Runner IS the Environment. If it doesn't run in the container, it doesn't exist.
#
# Tests executed within this environment generate cryptographically-bound
# TestExecutionManifests that serve as Evidence for the Semantic Judge.
#
# Network isolation ensures hermetic execution.
# Resource limits prevent denial-of-service.
# Non-root execution prevents privilege escalation.
# Read-only filesystem prevents state corruption.
#
# This is the Law of Deterministic Execution."
#
# — DAN (GID-07), Infrastructure Specialist
# — SAM (GID-06), Security Audit
# — 2026-01-25
#
# ============================================================================
